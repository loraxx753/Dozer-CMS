// Generated by CoffeeScript 1.6.2
(function() {
  var new_modal, update_page;

  String.prototype.capitalize = function() {
    return this.charAt(0).toUpperCase() + this.slice(1);
  };

  new_modal = function(url, callback) {
    $("body").append("<div id='modal_dump'></div>");
    return $("#modal_dump").load(url, function() {
      $('#myModal').modal();
      if (callback) {
        return callback($("#myModal"));
      }
    });
  };

  update_page = function($el) {
    var content, d, pages;

    content = $el.parent().prev();
    d = "disabled";
    if ($el.hasClass(d)) {
      $el.text("Updated");
      $el.removeClass(d).removeAttr(d);
      return $el.removeClass("btn-info").addClass("btn-primary");
    } else {
      pages = new Array();
      $(".page_row").each(function() {
        var page;

        page = {};
        page.id = $(this).data("id");
        page.parent_id = $(this).find(".parent_id").val();
        page.published = $(this).find(".published").val();
        return pages[page.id] = page;
      });
      $el.addClass(d).removeClass("btn-primary").addClass("btn-info").attr(d, d);
      $el.text("Updating...");
      return $.post("/admin/update/pages", {
        "pages": pages
      }, function(data) {
        update_page($el);
        $("nav").html(data.html);
        return $(".page_row").each(function() {
          var id;

          id = $(this).data("id");
          return $(this).find(".url").html('<a href="' + data.urls[id] + '">' + data.urls[id] + "</a>");
        });
      }, "json");
    }
  };

  $(".update_pages").on("click", function(e) {
    return update_page($(this));
  });

  $(".admin_newpage").on("click", function(e) {
    e.preventDefault();
    return new_modal("/assets/snippets/newpage.html", function() {
      return $('#newPageSave').on("click", function(e) {
        e.preventDefault();
        return $.post("/admin/create/page", {
          "name": $("#newPageName").val(),
          "parent_id": -1
        }, function(data) {
          return $.post("/assets/snippets/page_row.html", function(text) {
            var $real_select, $temp_select, $text, page, _i, _len, _ref;

            text = text.replace(/__page_id__/g, data.id).replace(/__page_name__/g, data.name).replace(/__page_url__/g, data.url);
            $text = $("<div></div>").append(text);
            $temp_select = $text.find(".parent_page_temp");
            _ref = data.pages;
            for (_i = 0, _len = _ref.length; _i < _len; _i++) {
              page = _ref[_i];
              $real_select = $temp_select.clone();
              $real_select.removeClass("parent_page_temp");
              $real_select.val(page.id);
              $real_select.text(page.name);
              $text.find(".parent_page_temp").after($real_select);
            }
            $text.find(".parent_page_temp").remove();
            $(".page_table").find("tbody").append($text.html());
            return $("#modal_dump").remove();
          });
        }, "json");
      });
    });
  });

  $("#admin_newmodel").on("click", function(e) {
    e.preventDefault();
    return new_modal("/assets/snippets/newmodal.html", function() {
      $("#add_field").on("click", function(e) {
        var $field;

        e.preventDefault();
        $field = $(this).parent().prev().clone();
        $field.find("input[type=text]").val('');
        $field.find("select").val("default");
        return $(this).parent().prev().after($field);
      });
      return $("#newModelSave").on("click", function(e) {
        var $form, args;

        e.preventDefault();
        $form = $(".model_form");
        args = [];
        args.push($form.find("input[name=name]").val());
        $(".fields").each(function() {
          return args.push($(this).find("input[type=text]").val() + ":" + $(this).find("select").val());
        });
        console.log(args);
        return $.post("/admin/create/model", {
          "args": args
        }, function(data) {
          return console.log(data);
        });
      });
    });
  });

  $(".add_entry").on("click", function(e) {
    var $this, fields, id, name;

    e.preventDefault();
    $this = $(this);
    id = $this.closest(".page_row").data("id");
    name = $this.closest("td").prevUntil(".model_name").last().prev().text();
    console.log($this.closest("td").prevUntil(".model_name").last().prev().text());
    fields = {};
    $this.closest("td").prevUntil(".field_list").prev().children("ul").children("li").each(function() {
      return fields[$(this).text()] = $(this).data('type');
    });
    return new_modal("/assets/snippets/model_entry.html", function($modal) {
      var $fieldClone, element, fieldtext, text, type;

      text = $modal.html();
      text = text.replace(/__Model_Name__/g, name.capitalize());
      $modal.html(text);
      for (element in fields) {
        type = fields[element];
        $fieldClone = $(".model_" + type).clone();
        $fieldClone.removeClass("hidden");
        fieldtext = $fieldClone.html();
        fieldtext = fieldtext.replace(/__Column_Name__/g, element.capitalize()).replace(/__column_name__/g, element);
        $fieldClone.html(fieldtext);
        $(".model_field_form").append($fieldClone);
        if ($fieldClone.hasClass("model_text")) {
          $fieldClone.children(".content").hallo({
            plugins: {
              'halloformat': {},
              'halloblock': {},
              'hallojustify': {},
              'hallolists': {},
              'hallolink': {},
              'halloreundo': {},
              'halloimage': {
                upload: function(data) {
                  return console.log("success");
                },
                uploadUrl: "/admin/imageupload"
              }
            },
            editable: true,
            toolbar: 'halloToolbarFixed'
          });
        }
      }
      return $("#modelEntrySave").on("click", function(e) {
        var model, obj, returned;

        e.preventDefault();
        obj = {};
        obj.name = name;
        obj.texts = (function() {
          var _i, _len, _ref, _results;

          _ref = $(".model_field_form .model_text");
          _results = [];
          for (_i = 0, _len = _ref.length; _i < _len; _i++) {
            model = _ref[_i];
            returned = {};
            returned.name = $(model).children("p").data("name");
            returned.content = $(model).find(".content").html();
            _results.push(returned);
          }
          return _results;
        })();
        obj.ints = (function() {
          var _i, _len, _ref, _results;

          _ref = $(".model_field_form .model_int");
          _results = [];
          for (_i = 0, _len = _ref.length; _i < _len; _i++) {
            model = _ref[_i];
            returned = {};
            returned.name = $(model).children("input").attr("id");
            returned.content = $(model).children("input").val();
            _results.push(returned);
          }
          return _results;
        })();
        obj.strings = (function() {
          var _i, _len, _ref, _results;

          _ref = $(".model_field_form .model_string");
          _results = [];
          for (_i = 0, _len = _ref.length; _i < _len; _i++) {
            model = _ref[_i];
            returned = {};
            returned.name = $(model).children("input").attr("id");
            returned.content = $(model).children("input").val();
            _results.push(returned);
          }
          return _results;
        })();
        return $.post("/admin/create/entry", obj, function(data) {});
      });
    });
  });

}).call(this);
